name: CICD Pipeline

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPOSITORY: my-repo
  IMAGE_NAME: heart-api

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install gcloud CLI
      run: |
        sudo apt-get update
        sudo apt-get install -y google-cloud-cli

    - name: Authenticate to GCP (Base64 key)
      env:
        GCP_B64: ${{ secrets.GCP_CREDENTIALS_B64 }}
      run: |
        echo "$GCP_B64" | base64 -d > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud config set project $PROJECT_ID

    - name: Configure Docker for Artifact Registry
      run: |
        gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

    - name: Build Docker image
      run: |
        docker build -t $IMAGE_NAME api/.

    - name: Tag Docker image
      run: |
        docker tag $IMAGE_NAME \
        $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:latest

    - name: Push Docker image
      run: |
        docker push \
        $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:latest
    
    - name: Create CD summary artifact
      run: |
        echo "CD PIPELINE SUMMARY" > cd_summary.txt
        echo "-------------------" >> cd_summary.txt
        echo "Docker image built successfully" >> cd_summary.txt
        echo "Image pushed to Artifact Registry" >> cd_summary.txt
        echo "Image: $REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/$IMAGE_NAME:latest" >> cd_summary.txt
        echo "Commit SHA: $GITHUB_SHA" >> cd_summary.txt
        echo "Workflow run: $GITHUB_RUN_ID" >> cd_summary.txt

    - name: Upload CD summary artifact
      uses: actions/upload-artifact@v4
      with:
        name: cd-summary
        path: cd_summary.txt

